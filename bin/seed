#!/usr/bin/env python

import sys
import argparse
import logging
import uuid
import pymongo
import validators

from libbabywalk.inputs import read_seeds_from_s3
from libbabywalk.db import record_seeds, create_requests


def main():

    parser = argparse.ArgumentParser()
    parser.add_argument('--verbose', '-v', action='count', default=0)

    parser.add_argument('--target', metavar='<s3 uri>', required=True)

    parser_file = parser.add_argument_group('tsv file')
    parser_file.add_argument('--input-file', metavar='<file>', default='seeds.tsv')
    parser_file.add_argument('--url-field', metavar='<field name>', required=True)
    parser_file.add_argument('--tag-field', metavar='<field name>', required=True)

    parser_crawl = parser.add_argument_group('crawl')
    parser_crawl.add_argument('--depth', metavar='<number>', required=True)
    parser_crawl.add_argument('--output', metavar='<object>', default='content')
    args = parser.parse_args()

    logging_level = logging.WARNING - min(logging.WARNING, (10 * args.verbose))
    logging.basicConfig(format='%(levelname)s: %(asctime)s: %(message)s',
                        level=logging_level)

    client = pymongo.MongoClient()
    db = client.crawling

    convert = to_seed(args.url_field, args.tag_field)

    stream = read_seeds_from_s3(args.target, args.input_file)
    raw_seeds = (convert(entry) for entry in stream)
    seeds = (seed for seed in raw_seeds if validators.url.url(seed['url']))

    record_seeds(db, seeds)

    request = {
        'depth': args.depth,
        'upload': args.target + '/' + args.output
    }
    create_requests(db, request)


def to_seed(url_field, tag_field):

    def wrapper(element):
        return {
            'url': element[url_field],
            'tag': element[tag_field]
        }

    return wrapper

if __name__ == '__main__':
    sys.exit(main())
